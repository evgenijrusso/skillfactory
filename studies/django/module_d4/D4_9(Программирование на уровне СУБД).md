# D4.9. Программирование на уровне СУБД

Теперь, когда мы познакомились с серверным программированием в СУБД, давайте порассуждаем о преимуществах и 
недостатках этого подхода применительно к проектированию приложения.

Под проектированием здесь мы имеем в виду правила, в соответствии с которыми мы разрабатываем приложение.

Традиционная топология современного приложения чаще всего состоит из трёх уровней компонентов:
1. Сервер баз данных — обеспечивает хранение данных (PostgreSQL).
2. Сервер приложения — реализует бизнес-логику приложения (Python-приложение).
3. Клиентское приложение — предоставляет интерфейс пользователя (веб-сайт, мобильное приложение).
 img

Такая топология (или архитектура) приложения является типичной. 
В этом случае информационные потоки выглядят следующим образом:

Пользователь, используя браузер или мобильный телефон, загружает приложение-клиент.
↓
Приложение пользователя обменивается информацией с сервером приложений.
↓
Сервер приложений взаимодействует с сервером БД, получая данные из БД и изменяя данные в БД.

При этом современный подход к проектированию ПО предполагает, что бизнес-логика (т.е. алгоритмы системы) реализована 
на стороне сервера приложений. Если бизнес-логика выносится в приложение пользователя или СУБД, то это в общем случае 
считается ошибкой.

Давайте рассмотрим этот аспект на примере нашего каталога товаров. Наше приложение состоит из:

- БД PostgreSQL;
- сервера приложений, разработанного на Python;
- веб-приложения маркетплейса.
Различные алгоритмы вроде выборки товаров связанных категорий, поиска похожих товаров, рекомендации товаров и пр., 
- очевидно, должны быть реализованы именно в Python-приложении. Странно было бы увидеть их в веб-приложении пользователя.

Однако не всегда эта грань чёткая и ясная. Зачастую возникает ситуация, когда какую-то часть бизнес-логики 
приложения можно реализовать либо на уровне сервера приложений, либо в СУБД.

К таким вещам можно отнести различную сложную сортировку и группировку, обновление связанных данных, 
вычисление какой-то статистики, выполнение поиска и многое другое. Например, мы хотим иметь возможность для 
выбранного пользователем товара подобрать похожие: товары той же категории с ценой +/- 30%. Очевидно, что можно 
реализовать этот алгоритм на сервере. Однако его же можно реализовать в виде хранимой функции в СУБД. 
Какой вариант следует выбрать?

Ответ на этот вопрос непростой и зависит от многих факторов.

В общем случае, однако, следует выбрать вариант реализации бизнес-логики в сервере приложений. 

Важно! Если у вас нет веских причин реализовывать логику в СУБД, то лучше этого не делать!

Давайте рассмотрим основные преимущества и недостатки обоих подходов.

### ------------------  Преимущества: -----------------------------------------------
- Реализация алгоритмов на уровне СУБД
1. Высокая скорость работы за счёт высокого качества и оптимизации кода СУБД, а также за счёт отсутствия 
необходимости передавать данные по сети. Код пишется на современном ЯП, используя современные среды разработки.
2. 
- Реализация алгоритмов на уровне сервера приложений
  1. Код пишется на современном ЯП, используя современные среды разработки.
  2. Код легко тестируется.
  3. Код не требует изучения дополнительных языков и гораздо легче и дешевле в сопровождении.

### ------------------  Недостатки: -----------------------------------------------
- Реализация алгоритмов на уровне СУБД
1. Требуется владение языком разработки СУБД (например, PLPGSQL).
2. Код на уровне СУБД не поддерживается средами разработки. Например, к нему нельзя перейти, щёлкнув по имени функции.
3. Код в СУБД практически не поддаётся модульному тестированию.
4. Отсутствуют современные средства разработки
5. Код на уровне СУБД часто меняет БД, после чего вернуть состояние назад очень непросто.

- Реализация алгоритмов на уровне сервера приложений
1. Для реализации сложной бизнес-логики может потребоваться большое количество запросов данных по сети, что сильно 
снижает производительность.
2. Код, как правило, менее качественный и оптимизированный, по сравнению с кодом СУБД.
3. Код может быть более многословным, чем код на SQL и других языках СУБД
4. Python и другие современные языки, как правило, хуже приспособлены для работы с табличными данными, чем SQL.

Давайте подведём итог. Профессиональный опыт подсказывает, что, несмотря на то, что код в СУБД обычно от 2 до 100 раз 
быстрее, чем код на уровне сервера приложений, не стоит писать логику в СУБД без веских причин. Дело в том, что обычно 
скорость выполнения кода значительно менее важна, чем простота кода и возможность его сопровождения. Разрабатывая логику 
в СУБД, вы, как правило, автоматически создаёте этакий чёрный ящик, разобраться в котором впоследствии становится крайне сложно.

Существуют, однако, редкие случаи, когда производительность ставится во главу угла, и код в СУБД обретает смысл. 
Чаще всего, тем не менее, следует реализовывать логику на стороне сервера приложения.

