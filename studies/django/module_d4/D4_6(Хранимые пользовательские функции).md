# D4.6. Хранимые пользовательские функции

Все современные СУБД предоставляют возможность реализовывать алгоритмы бизнес-логики в самой СУБД. 
Для этого в СУБД можно разрабатывать пользовательские функции и процедуры, используя различные языки программирования. 
Например, PostgreSQL поддерживает языки SQL, PLPGSQL, Perl, Python, TCL, JavaScript. 
То есть мы можем написать некоторую функцию на любом из этих языков и впоследствии вызывать её так же, 
как встроенные функции. Например, мы можем написать функцию, которая возвращает десять самых популярных товаров 
по идентификатору категории 
— top10(cat_id int) 
— и вызывать её потом с помощью: SELECT top10(24);

Традиционно наиболее популярным языком разработки пользовательских функций в PostgreSQL является язык PLPGSQL. 
PLPGSQL и SQL поддерживаются PostgreSQL по умолчанию. Поддержка других языков требует установки расширений СУБД.

Функции и процедуры, написанные на любом поддерживаемом СУБД языке, компилируются и хранятся в БД в виде 
полноценных объектов вместе с данными. Поэтому такие функции и процедуры называют хранимыми функциями и процедурами.

Подробное описание языка выходит за рамки нашей программы, 
однако вы можете почитать про него [здесь](https://postgrespro.ru/docs/postgresql/13/plpgsql).

Давайте посмотрим несколько несложных примеров.

Пример 1. Функция, возвращающая цену самого дорогого товара.

Используем язык PLPGSQL.
```
CREATE OR REPLACE FUNCTION highest_price() RETURNS int
LANGUAGE plpgsql
AS $$
BEGIN
RETURN (
	SELECT price
	FROM products
	WHERE price IS NOT NULL
	ORDER BY price DESC LIMIT 1
);
END;
$$;
```
Обратите внимание на формат CREATE OR REPLACE, который создаёт или заменяет существующую функцию с таким же именем. 
Знак $$ используется как кавычки. Так принято, хотя можно использовать любую комбинацию.
Проверьте результат выполнения функции.
- SELECT highest_price();

Пример 2. Функция, возвращающая все товары, цена которых выше некоторой величины.

Такая функция будет возвращать множество записей и иметь входной параметр целого типа. Текст функции будет примерно таким:
```
CREATE OR REPLACE FUNCTION price_over(n int) RETURNS SETOF products
LANGUAGE plpgsql
AS $$
DECLARE
	v record;
BEGIN
	FOR v IN 
		SELECT *
		FROM products
		WHERE price > n
	LOOP
		RETURN NEXT v;
	END LOOP;
END;
$$;
Если вызвать функцию:

SELECT price_over(150000);
```
Как вы могли заметить, язык PLPGSQL выглядит по современным меркам странно: используются блоки кода, 
ограниченные BEGIN и END, переменные объявляются в секции DECLARE. Возможно, кто-то из вас узнал прародителя 
целого семейства подобных языков — язык Паскаль. Если так, то вы абсолютно правы.

⚡ Мы не ставили целью научить вас программировать на встроенных языках СУБД, а хотели только продемонстрировать 
наличие такой возможности. Не только потому, что программирование в СУБД выходит за рамки программы курса, но и 
потому, что этого лучше вообще не делать! Далее в модуле мы расскажем, почему.

Примечание. Программирование в СУБД часто по традиции называют серверным программированием.
