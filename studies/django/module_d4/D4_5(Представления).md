# D4.5. Представления

Представление (view) — это виртуальная таблица, созданная в результате выполнения запроса SELECT. 
Представление имеет собственное имя и может использоваться как обычная таблица в запросах выборки данных и, 
при выполнении некоторых условий, операциях изменения данных.

Представление может быть построено любым валидным запросом на базе оператора SELECT, а это значит, что представление 
может содержать данные из различных таблиц.

Создадим представление, которое будет содержать информацию о товарах вместе с названиями поставщиков вместо их 
идентификаторов. Кроме того, давайте попрактикуемся в продвинутых возможностях SQL и добавим в наше представление 
ещё один столбец — разницу между ценой товара и средней ценой всех товаров.

Для создания такого вычисляемого столбца нам потребуется использовать вложенный запрос.

Вложенный запрос — это оператор SQL, заключённый в круглые скобки.

Запрос для создания такого представления будет выглядеть следующим образом:

-- создание представления goods
```
CREATE OR REPLACE VIEW goods
AS
SELECT
	products.id,
	products.name,
	products.price,
	vendors.name AS vendor,
	price - (SELECT avg(price) FROM products)::NUMERIC(10,0) AS delta
FROM
	products, vendors
WHERE products.vendor_id = vendors.id;
```
Обратите внимание на синтаксис вложенного запроса в описании атрибута delta. 
Этот приём используется очень часто, и его следует запомнить. 
Кроме того, в этом запросе применяется встроенная функция вычисления среднего значения по столбцу price.

В SQL можно приводить данные одного типа к другому, используя формат value::TYPE. Например, запрос:

SELECT '10', '10'::INT;

Теперь мы можем работать с представлением goods как с обычной таблицей. То есть запрос:

SELECT * FROM goods;

Вернёт такой результат: (см. pgadmin 4, db - catalog2)
Вероятно, что у вас уже возник вопрос: «А что будет с этим представлением и вычисленным столбцом delta, если добавить ещё одну запись в таблицу товаров?» Давайте проверим.

```
INSERT INTO products (name, price, vendor_id) VALUES ('Roland KX-1p', 100000, 2);
SELECT * FROM goods;
```

Как видите, изменились разности цены и добавился новый товар. Что это значит? 
При вставке новой строки виртуальная таблица-представление была перестроена? Нет. 
Представление было вычислено при выполнении запроса к нему.

Таким образом, можно считать представление некоторым аналогом функции или процедуры, 
поскольку оно позволяет упростить написание сложных составных запросов и вычисляется при обращении к нему.

В представлении, которое получает данные из одной таблицы, можно выполнять операторы, изменяющие данные. 
Поскольку у нас представление объединяет данные из двух таблиц, то попытка вставить запись вызовет ошибку.
````
CREATE OR REPLACE VIEW goods2
AS
SELECT
	products.id,
	products.name,
	products.price
FROM
	products
WHERE price BETWEEN 2000000 AND 5000000
```