# D3.15. SQL. Типы данных и функции

### В каждом языке программирования есть понятие типов данных. 
Даже в слабо типизированных, вроде JavaScript, всё равно «под капотом» для каждой переменной определён свой тип данных. 
SQL здесь не исключение. Для СУБД PostgreSQL сведения о типах данных 
можно почерпнуть [здесь](https://postgrespro.ru/docs/postgresql/13/datatype).

Почему выше я уточнил, что ссылка действительна именно для PostgreSQL? 
Потому что разные СУБД имеют разный набор поддерживаемых типов данных. 
Однако существует ряд типов, определённых в стандарте SQL, которые поддерживаются всеми СУБД.

К основным таким типам относятся:

Группа      Тип данных                  Описание
-----------------------------------------------------------------------------
Числовые    INT (INTEGER), BIGINT       Целочисленные типы, 4 или 8 байт.
-------------------------------------------------------------------------------
Числовые    FLOAT, DOUBLE               Числа с плавающей запятой, 4 или 8 байт.
----------------------------------------------------------------------------------
Строковые   VARCHAR(n)                  Строка переменной длины вплоть до n.
--------------------------------------------------------------------------------
Строковые   TEXT                        Строка произвольной длины.
---------------------------------------------------------------------------------
Логические  BOOL (BOOLEAN)              Истина или ложь (TRUE, FALSE).

Также СУБД позволяют хранить массивы, перечисления и различные другие типы данных, производные от базовых. 
Также некоторые СУБД добавляют к типам данных синтаксический сахар.

Синтаксический сахар — это упрощение синтаксиса, позволяющее кратко записать часто встречаемые операции. 
Того же результата, как правило, можно достичь более сложной записью. Синтаксический сахар делает программу проще для восприятия.

Примером такого синтаксического сахара в PostgreSQL являются типы данных SERIAL и BIGSERIAL. 
Эти типы мы используем для автоматического заполнения значений первичного ключа таблицы. 
По факту, СУБД создает атрибут типа INT, последовательность для генерации значений и связывает атрибут и последовательность. 
Всё то же самое можно сделать и самостоятельно, но проще воспользоваться SERIAL.

Несмотря на то, что для того и другого СУБД предоставляют специализированные типы данных, 
я рекомендую использовать в обоих случаях целый тип BIGINT. Для даты и времени использование формата Unix Time позволит 
не беспокоиться о конвертировании часовых поясов. Для денег использование целых чисел исключает проблемы потери при 
округлении, характерные для вещественных чисел. Цены и прочие денежные номиналы обычно хранятся в копейках (центах, пенсах и так далее).


### Слабоструктурированные типы
Отдельно стоит поговорить о слабоструктурированных типах. 
К таким типам в основном относят типы XML и JSON (JSONB). Такие типы называют слабоструктурированными, 
потому что данные, которые в них хранятся, не имеют строгой структуры. Структура таких данных часто меняется.

imgВозьмите паузу и попробуйте выявить слабоструктурированные данные в каталоге товаров.

В нашем каталоге могут храниться любые товары, а значит, у них могут быть любые свойства: от цвета и 
размера до морозостойкости. Чтобы хранить каждое такое свойство в виде самостоятельного атрибута, 
нам потребуется огромное количество столбцов в таблице товаров. Более того, при появлении новой категории 
товаров нужно будет добавлять новые столбцы.

Добавление новых столбцов блокирует таблицу, запрещая любые операции с ней до завершения добавления 
(подробнее о блокировках далее). Да и просто это не удобно. В таких случаях используют 
[тип JSON](https://postgrespro.ru/docs/postgresql/13/datatype-json) для хранения всех дополнительных атрибутов 
в виде отдельного документа. (XML сейчас почти не используется из-за тяжелой структуры).

JSON позволяет хранить сложные объекты в текстовом виде (объекты сериализованы в формат JSON). 
Далее в курсе мы будем изучать этот формат и работу с ним, но если он вам не знаком, рекомендую прочитать о нём уже сейчас. 
Для Python-разработчика JSON очень важен!

Обычно используется бинарный формат хранения, то есть тип JSONB. 
Он занимает значительно меньше места и эффективней при поиске. 
Таким образом, мы могли бы для наших товаров определить любые дополнительные атрибуты.

Например, для гитары из демонстрационных данных они могли бы выглядеть так:
* {"numOfStrings": 6, "handmade": false, "country": "USA"}

Такой JSON в терминах БД называют документом (отсюда документные базы данных). 
Тогда мы могли бы создать ещё один атрибут в таблице товаров для хранения дополнительных свойств товара. 
Давайте так и сделаем.

Добавляем столбец в таблицу:
```
ALTER TABLE products
ADD COLUMN specification JSONB DEFAULT '{}';
SELECT * FROM products;
```
Обратите внимание на директиву DEFAULT, задающую значение по умолчанию для столбца. 
Если бы её не было, то все записи получили бы для нового столбца значение NULL. 
Необходимость введения типов для хранения документов вызвана ограничениями табличной модели. 
Зачастую наша предметная область не позволяет создать жёстких и неизменных схем данных. 
В таких случаях использование JSON добавляет нам гибкости.

Помимо типов данных язык SQL содержит набор встроенных функций для выполнения популярных операций. 
СУБД значительно расширяет этот набор. Для PostgreSQL почитать про встроенные функции 
можно [здесь](https://postgrespro.ru/docs/postgresql/13/functions).


### Наиболее популярные следующие встроенные функции:

Группа                  Функции                         Описание
----------------------------------------------------------------------------------------------------------------
Агрегатные функции      count(), min(),                 Статистика. Количество элементов,  
                        max(), avg() и так далее        минимальный и максимальный элемент, среднее значение.
---------------------------------------------------------------------------------------------------------------
Математические          abs(), floor(), +,-,*,/         Основные математические операции. 
                        и так далее
-----------------------------------------------------------------------------------------------------------------
Строковые               ||, substring(), trim()         Основные операции со строками. 
и так далее

## Кроме того, СУБД предоставляет полный набор типовых операторов:

* сравнение,
* объединение,
* арифметические операции,
* логические операции,
* теоретико-множественные операции.

И так далее. Также доступны функции для работы со временем.

Функции всегда используются внутри оператора. 
Например, давайте получим минимальную, максимальную, среднюю цену товаров в таблице products вместе с количеством записей в ней.

* SELECT min(price), max(price), avg(price), count(*) FROM PRODUCTS;