# D3.16. Транзакции
Мы с вами в предыдущем модуле коснулись свойств ACID, которые СУБД гарантирует для наших баз данных. 
Кроме того, в данном модуле мы разбирали ограничения, которые являются свойствами атрибутов таблиц. 
Давайте подумаем, какой цели служат свойства ACID и ограничения.

И свойства ACID и, в особенности, ограничения предназначены для обеспечения логической целостности и
согласованности данных. Поэтому, кстати, ограничения и называются «ограничения целостности». 
Теперь нужно разобраться с понятием целостности или согласованности данных.

Логическая целостность или согласованность означает корректное, непротиворечивое состояние данных. 
Корректность здесь определяется схемой данных, которая, в свою очередь, является отражением предметной области.

Мы уже сталкивались с работой такого ограничения, когда пытались удалить из таблицы товаров запись, 
на которую ссылаются записи в другой таблице. СУБД выдала ошибку и операция была отменена. 
В результате состояние внешнего ключа в таблице «товары_категории» осталось корректным. 
Если бы запись всё-таки была удалена, то в таблице «товары_категории» осталась бы 
«битая ссылка» на товар, который уже не существует.

* Ограничения — один из двух основных высокоуровневых инструментов обеспечения целостности и согласованности данных. 
Второй — транзакции. Существуют довольно формальные и сложные определения транзакций, но я приведу здесь простое.

* Транзакция — операция с базой данных, которая либо выполняется полностью, либо не выполняется вообще.

Это означает, что любая транзакция не может быть выполнена частично. 
Например, если вы в одну транзакцию поместили десять операций вставки записи, то либо все десять операций 
будут зафиксированы в базе, либо ни одна. СУБД это гарантирует! Вставка только трёх записей невозможна.

На самом деле все операции в БД выполняются как транзакции. 
Даже если вы напишете только один оператор INSERT, то БД создаст соответствующую транзакцию. 
Механизм транзакций основан на журнале БД. Сначала все операции транзакции записываются в журнал, потом уже в файлы БД. 
Если где-то возникла ошибка, то по журналу все завершённые операции отыгрываются назад, и БД приводится в исходное состояние.

Каждая операция является транзакцией, но если вы написали запрос, в котором несколько операторов, 
то по умолчанию гарантий их согласованного выполнения нет. Вы можете самостоятельно объединить операции запроса в 
транзакцию, используя операторы начала и завершения транзакции.

Например, мы хотим в рамках одной транзакции добавить производителя и его товар, чтобы данные были согласованы, 
даже если операция прервётся на полпути по какой-то причине. В этом случае мы должны использовать транзакцию.
```
-- старт транзакции
BEGIN;
-- вставка нового производителя
INSERT INTO manufacturers (id, name) VALUES (100, 'Samsung');
-- вставка нового товара
INSERT INTO products (name, manufacturer_id) VALUES ('SyncMaster 3NE', 100);
-- перезапуск последовательности для id с номера 101
ALTER SEQUENCE manufacturers_id_seq RESTART WITH 101;
-- успешная фиксация транзакции
COMMIT;
```
Результат:
- SELECT * FROM products WHERE manufacturer_id = 100;

- Если по какой-то причине вы захотите в ходе выполнения транзакции отменить её и вернуть всё в исходное состояние, 
- то следует вместо COMMIT вызвать команду ROLLBACK.

С транзакциями также связаны два важных понятия: блокировки и уровни изоляции. 
С помощью блокировок СУБД гарантирует, что параллельные операции не соперничают друг с другом, 
а выполняются последовательно, одна за другой.

Например, если одна операция (транзакция) изменяет данные в строке, то пока изменение не завершится, 
доступ к этой строке будет заблокирован для всех других операций. Почитать об этом можно здесь.

Однако требования к высокой производительности СУБД при выполнении большого количества параллельных транзакций 
привели к разрешению частичного нарушения требований ACID для увеличения производительности параллельных транзакций. 
Соответствующие послабления объединены в режимы выполнения транзакций, называемые уровнями изоляции транзакций.

Каждый уровень описывает виды допустимых конфликтов между параллельными транзакциями. 
Подробное описание уровней изоляции выходит за рамки текущего модуля, но рекомендую про них всё же почитать. 
Это также одна из популярных тем на собеседовании (хотя и не для начинающих, полагаю).

# -------------------  Задание 3.17.2  --------------------------
Самостоятельно напишите и выполните применительно к БД объявлений следующие виды запросов:

Создание структуры БД.  -- ok 
Наполнение БД некоторыми тестовыми данными. -- ok
Переименование одной из таблиц. -- ok
Получение всех объявлений. - ok
Получение всех объявлений с именами пользователей. -- ok
Получение всех объявлений для некоторого ключевого слова.  -- ok
Добавление столбца с временем создания в таблицу объявлений.  - ok
Добавление ограничения проверки времени создания объявления: объявление должно быть создано позднее 1 января 2021 года в формате Unix Time.
Добавление и удаление ограничения уникальности времени создания.
Изменение столбца. Установка для времени создания значения по умолчанию. - ok